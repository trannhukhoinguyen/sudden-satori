---
import Layout from "../../layouts/Layout.astro";
import "@/styles/post.css";
import { configNew as config } from "../../config";
import { getCategoryData } from "../../utils/getMarkdownContent";
import { extractHeadings, filterHeadingsForTOC } from "../../utils/table-of-contents";
import { calculateReadingTime, extractTextFromMarkdown } from "../../utils/reading-time";
import TableOfContents from "../../components/TableOfContents.astro";
import BackToTop from "../../components/BackToTop.astro";
import FloatingTOC from "../../components/FloatingTOC.astro";
import MediaArea from "../../components/MediaArea.astro";

export async function getStaticPaths() {
  const allPaths: any[] = [];

  config.collections.forEach((category) => {
    const { posts } = getCategoryData(category);

    posts.forEach((post) => {
      const rawContent = post.body || post.rawContent?.() || "";
      const plainText = extractTextFromMarkdown(rawContent);
      const readingTime = calculateReadingTime(plainText);
      const allHeadings = extractHeadings(rawContent);
      const tocHeadings = filterHeadingsForTOC(allHeadings);

      const slug = post.file.split("/").pop()?.replace(/\.(md|mdx)$/, "");

      allPaths.push({
        params: { category, slug },
        props: { post, readingTime, tocHeadings, category },
      });
    });
  });

  return allPaths;
}

const { post, readingTime, tocHeadings, category } = Astro.props;
const categoryName = config.categoryNames[category] || category;
const { frontmatter, Content } = post as any;

const base = import.meta.env.BASE_URL;
const publishedTime = frontmatter.date ? new Date(frontmatter.date).toISOString() : undefined;
---

<Layout
  title={frontmatter.title}
  description={frontmatter.description || frontmatter.excerpt}
  type="article"
  publishedTime={publishedTime}
>
  <article class="blog-post">
    <header class="post-header">
      <h1 class="post-title">{frontmatter.title}</h1>
      <time class="post-date">{new Date(frontmatter.date).toLocaleDateString("vi-VN")}</time>
      <span>{readingTime}</span>
    </header>

    <TableOfContents headings={tocHeadings} />

    <div class="post-content">
      <MediaArea entry={post} />
      <Content />
    </div>

    <footer>
      {frontmatter.tags && frontmatter.tags.length > 0 && (
          <div class="post-tags">
            <span class="tags-label">Tags:</span>
            <div class="tag-list">
              {frontmatter.tags.map((tag: string) => (
                  <span class="tag">{tag}</span>
              ))}
            </div>
          </div>
      )}
      <div class="post-navigation">
        <a href={`/${category}`} class="back-to-blog">← Trở về trang Danh sách <span class="accent">{categoryName}</span></a>
      </div>
    </footer>
  </article>
</Layout>
