<script is:inline>
    const HUATOU_KEY = 'huatou_selected_question';
    const HUATOU_SUPPRESS = 'huatou_suppress_until';

    const huatous = [
        { text: 'Khi chưa có trời đất, ta là cái gì?', audio: '/audios/thoai-dau/Khi chưa có trời đất, ta là cái gì.m4a' },
        { text: 'Muôn pháp về một, một về chỗ nào?', audio: '/audios/thoai-dau/Muôn pháp về một, một về chỗ nào.m4a' },
        { text: 'Trước khi cha mẹ chưa sanh, mặt mũi bổn lai của ta ra sao?', audio: '/audios/thoai-dau/Trước khi cha mẹ chưa sanh, mặt mũi bổn lai của ta ra sao.m4a' },
        { text: 'Sanh từ đâu đến, chết đi về đâu?', audio: '/audios/thoai-dau/Sanh từ đâu đến, chết đi về đâu.m4a' },
        { text: 'Chẳng phải tâm, chẳng phải Phật, chẳng phải vật, là cái gì?', audio: '/audios/thoai-dau/Chẳng phải tâm, chẳng phải Phật, chẳng phải vật, là cái gì.m4a' },
        { text: 'Chẳng cùng muôn pháp làm bạn là người gì?', audio: '/audios/thoai-dau/Chẳng cùng muôn pháp làm bạn, là người gì.m4a' }
    ];
    /* ------------------ AUDIO PRELOAD ------------------ */
    const audioCache = {};

    function preloadAudios() {
        huatous.forEach((h, i) => {
            const a = new Audio(h.audio);
            a.preload = 'auto';
            audioCache[i] = a;
        });
    }

    function playHuatou(index) {
        const audio = audioCache[index];
        if (!audio) return;

        audio.currentTime = 0;
        audio.volume = 1;
        audio.play().catch(() => {});
    }

    /* ------------------ MODAL LOGIC ------------------ */
    function shouldSuppress() {
        const ts = localStorage.getItem(HUATOU_SUPPRESS);
        return ts && Date.now() < Number(ts);
    }

    function showInitialModal() {
        const wrapper = document.createElement('div');
        wrapper.innerHTML = `
      <div style="position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:9999;">
        <div style="background:white;padding:20px;border-radius:12px;max-width:450px;width:90%;">
          <h3 style="text-align:center">Xin chọn một câu thoại đầu</h3>
          <form id="huatou-form">
            ${huatous.map((h,i)=>`
              <label style="display:block;margin:8px 0">
                <input required type="radio" name="huatou" value="${i}"> ${h.text}
              </label>`).join('')}
            <button type="submit" style="margin-top:12px;width:100%">OK</button>
          </form>
        </div>
      </div>`;
        document.body.appendChild(wrapper);

        wrapper.querySelector('#huatou-form').onsubmit = e => {
            e.preventDefault();
            const index = Number(wrapper.querySelector('input[name="huatou"]:checked').value);
            localStorage.setItem(HUATOU_KEY, index.toString());
            playHuatou(index);
            wrapper.remove();
        };
    }

    function showReminderModal(index) {
        const wrapper = document.createElement('div');
        wrapper.innerHTML = `
      <div style="position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:9999;">
        <div style="background:white;padding:20px;border-radius:12px;max-width:450px;width:90%;">
          <h2 style="color:red;text-align:center">${huatous[index].text}</h2>
          <h3 style="text-align:center">NHỚ CHIẾU CỐ THOẠI ĐẦU</h3>
          <p style="text-align:center"><em>(Hỏi & Nhìn vào chỗ KHÔNG BIẾT)</em></p>
          <button id="suppress" style="width:100%;margin-top:10px">Tạm ẩn 1 giờ</button>
          <button id="close" style="width:100%;margin-top:10px;background:darkred;color:white">Đã rõ</button>
        </div>
      </div>`;
        document.body.appendChild(wrapper);

        playHuatou(index);

        wrapper.querySelector('#close').onclick = () => wrapper.remove();
        wrapper.querySelector('#suppress').onclick = () => {
            localStorage.setItem(HUATOU_SUPPRESS, (Date.now() + 3600000).toString());
            wrapper.remove();
        };
    }

    /* ------------------ BOOT ------------------ */
    window.addEventListener('DOMContentLoaded', () => {
        preloadAudios();

        const saved = localStorage.getItem(HUATOU_KEY);
        if (!saved) return showInitialModal();

        playHuatou(Number(saved));
        if (!shouldSuppress()) showReminderModal(Number(saved));
    });
</script>
