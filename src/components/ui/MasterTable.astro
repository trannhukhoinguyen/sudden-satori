---
import masterData from "../../data/masters/AllMasterDb.tsx";
import { toSlug } from "../../utils/helper";

const masterPosts = import.meta.glob('/src/content/masters/**/*.{md,mdx}', { eager: true });
const masterSlugSet = new Set(
    Object.keys(masterPosts).map(path => {
      const filename = path.split('/').pop() || '';
      return filename.replace(/\.(md|mdx)$/, '');
    })
);
---

<section class="table">
  <h2 class="title-accent-centered">BẢNG DANH SÁCH THIỀN SƯ</h2>

  <div class="toolbox"                                                                                                                  >
    <input type="text" id="inpValue" placeholder="Tìm kiếm" />
    <button id="btnClear">Clear (hoặc click ESC)</button>

<!--    <div class="control-panel">

      <label class="label"><input id="hasContent" type="checkbox" name="checkbox" checked/>
        Có bài viết</label>

      <label class="label"><input id="India" type="checkbox" name="checkbox"/>
        India</label>

      <label class="label"><input id="China" type="checkbox" name="checkbox" />
        China</label>

      <label class="label"><input id="Japan" type="checkbox" name="checkbox" />
        Japan</label>

      <label class="label"><input id="Vietnam" type="checkbox" name="checkbox" />
        Vietnam</label>

      <label class="label"><input id="Korea" type="checkbox" name="checkbox" />
        Korea</label>

    </div>-->


    <div class="download-actions">
      <button id="btnExcel" title="Export page hiện tại (10 dòng)">⬇ Excel</button>
      <button id="btnPdf" title="Export page hiện tại (10 dòng)">⬇ PDF</button>
    </div>
  </div>

  <table>
    <thead>
    <tr>
      <th class="table-head">Tên Anh</th>
      <th class="table-head">Tên Việt</th>
      <th class="table-head">Tên Trung</th>
      <th class="table-head">Tông phái</th>
      <th class="table-head">Thầy</th>
    </tr>
    </thead>
    <tbody>

    {
        masterData?.length
        && masterData?.map((master: any) => {
          const slug = toSlug(master.name_en);
          const hasPost = masterSlugSet.has(slug);
          console.log("masterData", masterData);
          return hasPost
              ? <tr>
                <td data-label="Tên Anh" class="table-data">
                  <a href={`/masters/${slug}`} target="_blank" class="table-data">{master.name_en}</a>
                </td>
                <td data-label="Tên Việt" class="table-data">{master.name_vi}</td>
                <td data-label="Tên Trung" class="table-data">{master.name_zh}</td>
                <td data-label="Tông phái" class="table-data">{master.sect?.join(', ')}</td>
                <td data-label="Thầy" class="table-data">{master.teachers?.join(', ')}</td>
              </tr>
              :  <tr>
            <td data-label="Tên Anh" class="table-data">
              { master.name_en }
            </td>
            <td data-label="Tên Việt" class="table-data">{master.name_vi}</td>
            <td data-label="Tên Trung" class="table-data">{master.name_zh}</td>
            <td data-label="Tông phái" class="table-data">{master.sect?.join(', ')}</td>
            <td data-label="Thầy" class="table-data">{master.teachers?.join(', ')}</td>
          </tr>
        }
      )
    }

    </tbody>
  </table>

  <button onclick="currentPage--; paginate()">Prev</button>
  <div class="pagination" id="pagination"></div>
  <button onclick="currentPage++; paginate()">Next</button>

  <label for="rowsPerPage" class="sr-only">
    Số record mỗi trang
  </label>

  <select id="rowsPerPage" onchange="rowsPerPage = +this.value; paginate()">
    <option value="10">10</option>
    <option value="20">20</option>
    <option value="50">50</option>
  </select>
</section>

<style>
.table {
  position: relative;
  font-family: sans-serif;
  padding: 4px;
  width: 100%;
  overflow-x: hidden;   /* chặn kéo ngang */

  .toolbox {
    text-align: center;
    padding: 5px;
    background-color: #f9f9f9;
    border: 1px solid #ddd;
    border-radius: 2px;
    margin-bottom: 20px;

    .download-actions {
      margin-top: 8px;
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .download-actions button {
      min-width: 120px;
      height: 40px;
      border-radius: 6px;
      border: 1px solid #ccc;
      background: #fff;
      cursor: pointer;
      font-weight: 500;
    }
  }

  .info-panel p {
    font-size: 12px;
  }

  a {
    text-decoration: none;
    font-size: 12px;
  }

  #inpValue {
    width: 90%;

    margin: 10px 2px 2px 10px;
    padding: 5px;
    border: 1px solid #eee;
  }

  .control-panel {
    padding: 5px;
  }

  label {
    display: inline-block;
    color: var(--color-accent-maroon);
  }

  table {
    width: 100%;
    border-collapse: collapse;
    border: 1px solid #ddd;
    text-align: left;
  }

  th {
    background-color: var(--color-text-title-accent);
    padding: 5px;
    color: var(--color-accent-maroon);
  }

  tr {
    border-bottom: 1px solid #ddd;
  }

  tr th:first-child {
    //width: 70%;
  }

  td {
    padding: 5px;

    word-break: break-word;
    overflow-wrap: anywhere;
    max-width: 100%;
    white-space: normal;
  }

  .table-data {
    //color: var(--color-accent-gold);
  }

  .pagination button {
    margin: 3px;
    padding: 5px 8px;
    cursor: pointer;
    border: 1px solid #ddd;
    background: #f9f9f9;
  }

  .pagination button.active {
    background: #cc9c04;
    color: white;
  }

  #pagination .dots {
      display: flex;
      align-items: center;
      padding: 0 6px;
      color: #777;
      font-weight: 600;
      user-select: none;
  }
    #pagination {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;                 /* khoảng cách giữa các nút */
        margin-top: 16px;
        justify-content: center;  /* căn giữa */
    }

    #pagination button {
        min-width: 44px;          /* chuẩn touch mobile */
        height: 44px;
        padding: 0 12px;

        border-radius: 6px;
        border: 1px solid #ccc;

        background: #fff;
        color: #333;

        font-size: 14px;
        font-weight: 500;

        cursor: pointer;
        transition: all 0.2s ease;
    }

    /* Hover */
    #pagination button:hover {
        background: #f0f0f0;
    }

    /* Active page */
    #pagination button.active {
        background: #007bff;
        color: #fff;
        border-color: #007bff;
    }

    /* Disabled (nếu có dùng Prev / Next) */
    #pagination button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    @media (max-width: 480px) {
        #pagination {
            gap: 10px;
        }

        #pagination button {
            min-width: 48px;
            height: 48px;
            font-size: 15px;
        }
    }

  @media (max-width: 640px) {
    table,
    thead,
    tbody,
    th,
    tr,
    td {
      display: block;
      width: 100%;
    }

    thead {
      display: none; /* ẩn header */
    }

    tr {
      margin-bottom: 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 8px;
    }

    td {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      padding: 6px 0;
      border: none;
      font-size: 14px;
    }

    td::before {
      content: attr(data-label);
      font-weight: 600;
      flex-shrink: 0;
    }
  }
}
</style>


<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.29/dist/jspdf.plugin.autotable.min.js"></script>

<script is:inline>
  // ===== Controls =====
  const btnClear = document.getElementById("btnClear");
  const inpValue = document.getElementById("inpValue");

  // ===== Table rows =====
  const table = document.querySelector("table tbody");
  const rows = Array.from(table.querySelectorAll("tr"));

  // ===== Pagination =====
  const rowsPerPage = 10;
  let currentPage = 1;

  function paginate() {
      const matchedRows = allRows.filter(r => r.dataset.match === "true");
      const pageCount = Math.ceil(matchedRows.length / rowsPerPage);

      // Ẩn tất cả
    allRows.forEach(r => (r.style.display = "none"));

      // Hiển thị 10 record của page hiện tại
    const start = (currentPage - 1) * rowsPerPage;
      const end = start + rowsPerPage;

      matchedRows.slice(start, end).forEach(r => {
          r.style.display = "";
          });

      buildPagination(pageCount);
    }

  // ===== Events =====
  btnClear.addEventListener("click", () => {
    inpValue.value = "";
    applyFilter();
  });

  inpValue.addEventListener("keyup", e => {
    if (e.key === "Escape") inpValue.value = "";
    applyFilter();
  });

  // ===== Filter logic =====
  function applyFilter() {
    const pattern = new RegExp(inpValue.value, "i");

    rows.forEach(row => {
      const td = row.getElementsByTagName("td")[1];
      row.dataset.match = td && td.innerHTML.search(pattern) > -1
        ? "true"
        : "false";
    });

    currentPage = 1; // reset page khi filter đổi
    paginate();
  }
  // ===== Pagination logic =====
  function paginate() {
    const matchedRows = rows.filter(r => r.dataset.match === "true");
    const pageCount = Math.ceil(matchedRows.length / rowsPerPage);

    // hide all
    rows.forEach(r => (r.style.display = "none"));

    // show current page
    const start = (currentPage - 1) * rowsPerPage;
    const end = start + rowsPerPage;

    matchedRows.slice(start, end).forEach(r => {
      r.style.display = "";
    });

    buildPagination(pageCount);
  }

  // ===== Pagination buttons =====
  function buildPagination(pageCount) {
    const paginationEl = document.getElementById("pagination");
    paginationEl.innerHTML = "";

    if (pageCount <= 1) return;

    const maxVisible = 5;
    const half = Math.floor(maxVisible / 2);

    let start = Math.max(2, currentPage - half);
    let end = Math.min(pageCount - 1, currentPage + half);

    // Điều chỉnh khi gần đầu
    if (currentPage <= half + 1) {
      start = 2;
      end = Math.min(pageCount - 1, maxVisible + 1);
    }

    // Điều chỉnh khi gần cuối
    if (currentPage >= pageCount - half) {
      start = Math.max(2, pageCount - maxVisible);
      end = pageCount - 1;
    }

    // Page 1
    addPageButton(1);

    // Dấu ...
    if (start > 2) addDots();

    // Các page giữa
    for (let p = start; p <= end; p++) {
      addPageButton(p);
    }

    // Dấu ...
    if (end < pageCount - 1) addDots();

    // Page cuối
    addPageButton(pageCount);

    // ===== helpers =====
    function addPageButton(page) {
      const btn = document.createElement("button");
      btn.textContent = page;
      if (page === currentPage) btn.classList.add("active");

      btn.addEventListener("click", () => {
        currentPage = page;
        paginate();
      });

      paginationEl.appendChild(btn);
    }

    function addDots() {
      const span = document.createElement("span");
      span.textContent = "…";
      span.className = "dots";
      paginationEl.appendChild(span);
    }
  }

  // ===== Init =====
  rows.forEach(r => (r.dataset.match = "true"));
  paginate();

//Download
function getCurrentPageRows() {
    const matchedRows = rows.filter(r => r.dataset.match === "true");

    const start = (currentPage - 1) * rowsPerPage;
    const end = start + rowsPerPage;

    return matchedRows.slice(start, end);
    }

//Download Excel
document.getElementById("btnExcel").addEventListener("click", () => {
    const pageRows = getCurrentPageRows();

    if (!pageRows.length) return;

    const data = pageRows.map(row => {
    const cells = row.querySelectorAll("td");
    return {
        "Tên Anh": cells[0]?.innerText || "",
        "Tên Việt": cells[1]?.innerText || "",
        "Tên Trung": cells[1]?.innerText || "",
        "Tông phái": cells[2]?.innerText || "",
        "Thầy": cells[3]?.innerText || ""
    };
    });

    const worksheet = XLSX.utils.json_to_sheet(data);
    const workbook = XLSX.utils.book_new();

    XLSX.utils.book_append_sheet(
        workbook,
        worksheet,
        `Page ${currentPage}`
        );

    XLSX.writeFile(
        workbook,
        `danh-sach-thien-su-page-${currentPage}.xlsx`
        );
    });

// Download PDF
document.getElementById("btnPdf").addEventListener("click", () => {
    const pageRows = getCurrentPageRows();
    if (!pageRows.length) return;

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF("l", "pt", "a4");

    const body = pageRows.map(row => {
    const cells = row.querySelectorAll("td");
    return [
        cells[0]?.innerText || "",
        cells[1]?.innerText || "",
        cells[2]?.innerText || "",
        cells[3]?.innerText || "",
        cells[4]?.innerText || "",
        ];
    });

    doc.text(
        `BẢNG DANH SÁCH THIỀN SƯ - Page ${currentPage}`,
        40,
        40
        );

    doc.autoTable({
        head: [[
          "Tên Anh",
          "Tên Việt",
          "Tên Trung",
          "Tông phái",
          "Thầy",
        ]],
        body,
        startY: 60,
        styles: {
            fontSize: 9,
            cellPadding: 4,
            overflow: "linebreak"
            },
        margin: { left: 40, right: 40 }
        });

    doc.save(`danh-sach-thien-su-page-${currentPage}.pdf`);
    });
</script>

