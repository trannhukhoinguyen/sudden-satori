---
interface Props {
  colors?: [number, number, number][];
}

const defaultColors = [
  [180, 150, 250],
  [236, 231, 253],
  [141, 115, 245],
  [220, 210, 250],
];

const { colors = defaultColors } = Astro.props;
---

<sy-gradient-bg data-colors={JSON.stringify(colors)}></sy-gradient-bg>

<script>
  import { addIntersectingTicker } from "../utils/globalTicker";

  class GradientBackground extends HTMLElement {
    step = 0;
    colorIndices = [0, 1, 2, 3];
    gradientSpeed = 0.002;
    colors: number[][];

    constructor() {
      super();

      this.colors = JSON.parse(this.dataset.colors || "");
      addIntersectingTicker(this);
    }

    tick(t: number) {
      const colors = this.colors;
      const colorIndices = this.colorIndices;
      const step = this.step;

      const c00 = colors[colorIndices[0]];
      const c01 = colors[colorIndices[1]];
      const c10 = colors[colorIndices[2]];
      const c11 = colors[colorIndices[3]];

      const istep = 1 - step;
      const r1 = Math.round(istep * c00[0] + step * c01[0]);
      const g1 = Math.round(istep * c00[1] + step * c01[1]);
      const b1 = Math.round(istep * c00[2] + step * c01[2]);
      const color1 = "rgb(" + r1 + "," + g1 + "," + b1 + ")";

      const r2 = Math.round(istep * c10[0] + step * c11[0]);
      const g2 = Math.round(istep * c10[1] + step * c11[1]);
      const b2 = Math.round(istep * c10[2] + step * c11[2]);
      const color2 = "rgb(" + r2 + "," + g2 + "," + b2 + ")";

      this.style.backgroundImage = `linear-gradient(${Math.round(90 + (Math.cos(t / 10000) * 10 * 100) / 100)}deg, ${color1} 0%, ${color2} 100%)`;

      this.step += this.gradientSpeed;
      if (this.step >= 1) {
        this.step %= 1;

        colorIndices[0] = colorIndices[1];
        colorIndices[2] = colorIndices[3];

        const n = Math.random();
        colorIndices[1] =
          (colorIndices[1] + Math.floor(1 + n * (colors.length - 1))) %
          colors.length;
        colorIndices[3] =
          (colorIndices[3] +
            Math.floor(1 + (Math.random() + n) * (colors.length - 1))) %
          colors.length;
      }
    }
  }

  customElements.define("sy-gradient-bg", GradientBackground);
</script>

<style>
  sy-gradient-bg {
    position: absolute;
    top: 0;
    left: 0;

    width: 100%;
    height: 100%;
  }
</style>
